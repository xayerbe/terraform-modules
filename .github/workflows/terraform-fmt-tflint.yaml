name: Terraform fmt and tflint testing

on:
  pull_request:
    paths:
      - '**/*.tf'
      - '**/*.tfvars'
      - '.github/workflows/terraform-validate-test.yaml'
  push:
    branches: [main]
    paths:
      - '**/*.tf'
      - '**/*.tfvars'
env:
  TF_VERSION: 1.14.3
  AWS_REGION: eu-west-1

jobs:
  detect-changes:
    name: Detect Changed Workloads
    runs-on: ubuntu-latest
    outputs:
      workload-paths: ${{ steps.detect.outputs.workload-paths }}
      has-changes: ${{ steps.detect.outputs.has-changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed workloads with Terraform files
        id: detect
        run: |
          echo "ğŸ” Detecting workloads with modified Terraform files..."
          
          # Determine the comparison reference based on event type
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            COMPARE_REF="origin/${{ github.base_ref }}"
            echo "ğŸ“‹ PR mode: comparing against $COMPARE_REF"
          else
            # For push events, compare against the previous commit
            COMPARE_REF="HEAD~1"
            echo "ğŸ“‹ Push mode: comparing against $COMPARE_REF"
          fi
          
          # Get changed files
          CHANGED_FILES=$(git diff --name-only $COMPARE_REF..HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Find unique workload directories that have .tf file changes
          WORKLOAD_DIRS=$(echo "$CHANGED_FILES" | grep '\.tf$\|\.tfvars$' | cut -d'/' -f1-2 | sort -u)
          
          if [ -z "$WORKLOAD_DIRS" ]; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "workload-paths=[]" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No Terraform files were modified"
            exit 0
          fi
          
          # Validate that these directories exist and contain .tf files
          VALID_WORKLOADS=""
          for dir in $WORKLOAD_DIRS; do
            if [[ -d "$dir" ]] && [[ $(find "$dir" -name "*.tf" -type f | head -1) ]]; then
              if [[ -z "$VALID_WORKLOADS" ]]; then
                VALID_WORKLOADS="\"$dir\""
              else
                VALID_WORKLOADS="$VALID_WORKLOADS,\"$dir\""
              fi
              echo "âœ… Valid workload found: $dir"
            else
              echo "â­ï¸ Skipping invalid workload: $dir (no .tf files or doesn't exist)"
            fi
          done
          
          if [[ -z "$VALID_WORKLOADS" ]]; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "workload-paths=[]" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No valid workloads with Terraform files found"
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "workload-paths=[$VALID_WORKLOADS]" >> $GITHUB_OUTPUT
            echo "ğŸ“ Workloads to validate: [$VALID_WORKLOADS]"
          fi

  terraform-validate-test:
    name: Validate Terraform Workload
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    permissions:
      contents: read
      pull-requests: write
      id-token: write
      
    strategy:
      fail-fast: false
      matrix:
        workload-path: ${{ fromJson(needs.detect-changes.outputs.workload-paths) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Git Credentials for Private Modules
        run: |
          git config --global url."https://${{ secrets.GH_PAT }}@github.com/".insteadOf "https://github.com/"

      - name: Set environment variable to lowercase
        shell: bash
        run: echo "env_name=$(echo ${{ (github.event_name == 'pull_request' && (github.event.pull_request.base.ref == 'main' && 'pro' || (github.event.pull_request.base.ref == 'pre' && 'pre' || (github.event.pull_request.base.ref == 'dev' && 'dev' || 'null')))) || 'null' }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        working-directory: ${{ matrix.workload-path }}
        run: |
          echo "ğŸ” Checking Terraform formatting for ${{ matrix.workload-path }}"
          OUTPUT=$(terraform fmt -check -recursive 2>&1)
          echo "$OUTPUT"
          
          if [ $? -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.50.0

      - name: Run TFLint
        id: tflint
        working-directory: ${{ matrix.workload-path }}
        run: |
          echo "ğŸ” Running TFLint for ${{ matrix.workload-path }}"
          tflint --init
          OUTPUT=$(tflint --recursive --minimum-failure-severity=error 2>&1)
          echo "$OUTPUT"
          
          if [ $? -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true


      - name: Comment PR with results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          FMT_STATUS: ${{ steps.fmt.outputs.status }}
          INIT_STATUS: ${{ steps.init.outputs.status }}
          VALIDATE_STATUS: ${{ steps.validate.outputs.status }}
          TFLINT_STATUS: ${{ steps.tflint.outputs.status }}
        with:
          script: |
            const workloadPath = '${{ matrix.workload-path }}';
            const fmtStatus = process.env.FMT_STATUS;
            const tflintStatus = process.env.TFLINT_STATUS;
            
            const statusEmoji = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'failure') return 'âŒ';
              if (status === 'warning') return 'âš ï¸';
              if (status === 'cancelled') return 'âš ï¸';
              return 'â“';
            };
            
            const comment = `## ğŸ” Terraform Validation Results for \`${workloadPath}\`
            
            | Check | Status |
            |-------|--------|
            | Format Check | ${statusEmoji(fmtStatus)} ${fmtStatus} |
            | TFLint | ${statusEmoji(tflintStatus)} ${tflintStatus} |
            
            ${fmtStatus === 'failure' ? 'âš ï¸ **Format issues detected.** Run `terraform fmt -recursive` to fix.' : ''}
            ${tflintStatus === 'failure' ? 'âš ï¸ **TFLint issues detected.** Please review and fix linting issues.' : ''}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Summary of results
        if: always()
        run: |
          echo "## ğŸ“Š Summary for ${{ matrix.workload-path }}"
          echo "- Format: ${{ steps.fmt.conclusion }}"
          echo "- TFLint: ${{ steps.tflint.conclusion }}"